# Base image
FROM nvidia/cuda:13.0.1-base-ubuntu24.04
# Install Miniconda
WORKDIR /aiwaifu
RUN apt-get update && apt-get install -y wget bzip2 build-essential libgl1 libglib2.0-0 && \
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /miniconda.sh && \
    bash /miniconda.sh -b -p /opt/conda && \
    rm /miniconda.sh && \
    rm -rf /var/lib/apt/lists/*
ENV PATH="/opt/conda/bin:$PATH"

# Copy data
COPY . /aiwaifu

# Create .venv
RUN conda create -n .venv -y && \
    conda init
    
# Copy the Conda environment file and install
RUN conda install -n .venv -c conda-forge mamba 
RUN mamba env update
RUN conda clean --all --yes

# Activate the Conda environment by default
ENV PATH=".venv/bin:$PATH"
SHELL ["conda", "run", "-n", "aiwaifu", "/bin/bash", "-c"]

RUN conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main && \
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

# Copy data
COPY . /aiwaifu
WORKDIR /aiwaifu

# Install requirements
RUN pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128 && \
    pip install -r requirements.txt 

# RUN python3 main.py --help

# Expose port 7272 (the new default port)
EXPOSE 7272

# The code to run when container is started:
ENTRYPOINT ["conda", "run", "-n", ".venv", "python3", "main.py --config=example"]
# CMD ["python3", "main.py --config=example"]
