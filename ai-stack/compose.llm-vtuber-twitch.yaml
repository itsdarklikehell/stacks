services:
  open-llm-vtuber:
    image: t41372/open-llm-vtuber:latest
    container_name: open-llm-vtuber
    ports:
      - "3000:3000"
    environment:
      - TZ=Europe/Amsterdam
    # Add volumes or GPU as needed

  vtuber-streamer:
    image: jrottenberg/ffmpeg:latest
    container_name: vtuber-streamer
    depends_on:
      - open-llm-vtuber
    environment:
      - DISPLAY=:99
      - TWITCH_STREAM_KEY=${TWITCH_STREAM_KEY}
    volumes:
      - ../DATA/output:/input
    command: >
      bash -c "\
        apt-get update && apt-get install -y xvfb chromium-driver chromium-browser && \
        Xvfb :99 -screen 0 1280x720x24 & \
        sleep 3 && \
        chromium-browser --no-sandbox --headless --disable-gpu --window-size=1280,720 --app=http://open-llm-vtuber:3000 & \
        sleep 5 && \
        ffmpeg -f x11grab -video_size 1280x720 -i :99.0 -f flv rtmp://live.twitch.tv/app/${TWITCH_STREAM_KEY}"

  vtuber-twitch-bot:
    build:
      context: ./llm-vtuber-twitch-bot
    container_name: vtuber-twitch-bot
    environment:
      - TWITCH_CHANNEL=${TWITCH_CHANNEL}
      - TWITCH_BOT_OAUTH=${TWITCH_BOT_OAUTH}
      - VTUBER_API_URL=ws://open-llm-vtuber:3000/api/ws
    depends_on:
      - open-llm-vtuber
    restart: unless-stopped
