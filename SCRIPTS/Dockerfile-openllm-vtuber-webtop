# 1. Gebruik de basis Webtop (geen extra repo's)
FROM lscr.io/linuxserver/webtop:ubuntu-kde

# 2. Forceer software rendering voor de GUI (tegen crashes)
ENV __GLX_VENDOR_LIBRARY_NAME=mesa
ENV LD_IGNORE_OPTIMIZATION=1

# 3. Installeer alleen de noodzakelijke systeem-tools + MeCab voor Japanse TTS
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    ffmpeg \
    libmecab-dev \
    python3-pip \
    python3-venv \
    libpulse0 \
    && rm -rf /var/lib/apt/lists/*

# 4. Installeer 'uv'
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# 5. We maken GEEN venv in de Dockerfile.
# We maken alleen de map aan met de juiste rechten.
RUN mkdir -p /app_venv && chown -R 1000:1000 /app_venv

# 6. Maak de venv en de app map (alles als root voor nu)
RUN uv venv /app_venv && \
    mkdir -p /app

# 7. Open-LLM-VTuber installatie
WORKDIR /app
RUN git clone https://github.com/Open-LLM-VTuber/Open-LLM-VTuber.git --recursive . && \
    # Verwijder de versie-eis in ALLE bestanden (requirements, pyproject.toml, setup.py)
    find . -type f -name "*" -exec sed -i 's/sherpa-onnx==[0-9.]*/sherpa-onnx/g' {} + && \
    # Installeer het project en dwing een moderne sherpa-onnx af
    uv pip install --python /app_venv/bin/python "sherpa-onnx>=1.10.0" && \
    uv pip install --python /app_venv/bin/python . && \
    uv pip install --python /app_venv/bin/python edge-tts

# 8. MeloTTS installatie
WORKDIR /opt/MeloTTS
RUN git clone https://github.com/myshell-ai/MeloTTS.git --recursive . && \
    find . -type f -exec sed -i 's/transformers==[0-9.]*/transformers>=4.40/g' {} + && \
    find . -type f -exec sed -i 's/tokenizers==[0-9.]*/tokenizers>=0.19/g' {} + && \
    # Installeer de basis + mecab-python3
    uv pip install --python /app_venv/bin/python "tokenizers>=0.19" "transformers>=4.40" onnxruntime-gpu mecab-python3 && \
    uv pip install --python /app_venv/bin/python -e . && \
    /app_venv/bin/python -m unidic download

# 8a. (Extra) Sherpa-ONNX Modellen downloaden
WORKDIR /app/models
RUN wget -q https://github.com/k2-fsa/sherpa-onnx/releases/download/asr-models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2024-07-17.tar.bz2 && \
    tar xvf "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2024-07-17.tar.bz2" && \
    rm "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2024-07-17.tar.bz2"

RUN wget -q https://github.com/k2-fsa/sherpa-onnx/releases/download/asr-models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2025-09-09.tar.bz2 &&  \
    tar xvf "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2025-09-09.tar.bz2" && \
    rm "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2025-09-09.tar.bz2"

# 9. S6 Service voor de VTuber Server (Automatisering)
RUN mkdir -p /etc/services.d/vtuber-server && \
    printf "#!/bin/bash\nsleep 10\ncd /app\nexec /app_venv/bin/python run_server.py\n" > /etc/services.d/vtuber-server/run && \
    chmod +x /etc/services.d/vtuber-server/run

# 10. Browser Autostart (Opent de VTuber interface in de KDE desktop)
RUN mkdir -p /custom-cont-init.d && \
    printf "#!/bin/bash\n( until curl -s http://localhost:12393 > /dev/null; do sleep 5; done; export DISPLAY=:1; sudo -u abc chromium --no-sandbox http://localhost:12393) &\n" > /custom-cont-init.d/99-start-browser-vtuber && \
    chmod +x /custom-cont-init.d/99-start-browser-vtuber

# 11. Zorg dat alle nieuwe bestanden de juiste rechten hebben
RUN chown -R 1000:1000 /app /app_venv /opt/MeloTTS /config

WORKDIR /config
EXPOSE 3000 3001 12393

