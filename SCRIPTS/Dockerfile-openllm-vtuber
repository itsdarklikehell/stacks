# 1. Gebruik Webtop als basis (Ubuntu-KDE)
FROM lscr.io/linuxserver/webtop:ubuntu-kde

# Voorkom interactieve prompts
ENV DEBIAN_FRONTEND=noninteractive

# 2. Systeem dependencies + CUDA 12.1 repositories
RUN apt-get update && apt-get install -y wget gnupg2 curl ca-certificates && \
    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb && \
    dpkg -i cuda-keyring_1.1-1_all.deb && \
    apt-get update && \
    apt-get install -y \
    cuda-nvrtc-12-1 \
    cuda-cudart-12-1 \
    libcudnn8 \
    python3-pip python3-dev cmake \
    git libportaudio2 libasound2-dev \
    portaudio19-dev build-essential gcc g++ ffmpeg libmecab-dev cron && \
    rm -rf /var/lib/apt/lists/* cuda-keyring_1.1-1_all.deb

# 3. Installeer 'uv' via de officiÃ«le binary
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# 4. Python installatie
COPY requirements.txt /tmp/
ENV UV_SYSTEM_PYTHON=1

RUN rm -f /usr/lib/python3.12/EXTERNALLY-MANAGED && \
    # Installeer Torch + Torchaudio SAMEN uit de CUDA index
    uv pip install \
    --index-url https://download.pytorch.org/whl/cu124 \
    torch==2.5.1 torchaudio==2.5.1 && \
    grep -vE "torch|torchaudio|sherpa-onnx|edge-tts" /tmp/requirements.txt > /tmp/req_cleaned.txt && \
    uv pip install -r /tmp/req_cleaned.txt && \
    # FIX: Installeer versie 7.2.1 om de "No audio received" fout te herstellen
    uv pip install sherpa-onnx funasr modelscope huggingface_hub pywhispercpp "edge-tts==7.2.1" azure-cognitiveservices-speech py3-tts

# 5. MeloTTS installatie
WORKDIR /opt/MeloTTS
RUN git clone https://github.com/myshell-ai/MeloTTS.git /opt/MeloTTS && \
    uv pip install "numpy<2.0.0" && \
    uv pip install \
    "tokenizers>=0.19" "transformers>=4.40" "setuptools>=65" \
    "Cython" "fugashi" "unidic" "unidic-lite" "mecab-python3" \
    "cn2an" "py3-tts" "jieba" "pypinyin" "anyascii" "librosa" \
    "scipy" "jamo" "num2words" "tiktoken" "inflect" "pykakasi" \
    "g2p_en" "gruut" "gruut-lang-en" "gruut-lang-fr" "gruut-lang-de" "gruut-lang-es" \
    "cached-path" "alt-profanity-check" && \
    uv pip install --no-deps -e . && \
    python3 -m unidic download && \
    python3 melo/init_downloads.py

# 6. App setup & KasmVNC Audio Force
WORKDIR /app
COPY . /app

RUN mkdir -p /config/.kasms/ && \
    printf "encoding:\n  audio: true\n  audio_fixed: true\n" > /config/.kasms/kasmvnc.yaml && \
    chown -R 1000:1000 /config/.kasms/

# 7a. SERVER SERVICE
RUN mkdir -p /custom-services.d && \
    printf "#!/bin/bash\ncd /app\nexec python3 run_server.py\n" > /custom-services.d/vtuber-server && \
    chmod +x /custom-services.d/vtuber-server

# 7b. BROWSER AUTOSTART
RUN mkdir -p /root/defaults && \
    printf "bash -c 'sleep 20 && chromium --no-sandbox --no-first-run --use-fake-ui-for-media-stream --autoplay-policy=no-user-gesture-required --unsafely-treat-insecure-origin-as-secure=http://localhost:12393 --user-data-dir=/config/.config/chromium --password-store=basic http://localhost:12393 https://app.letta.com'\n" > /root/defaults/autostart && \
    chmod +x /root/defaults/autostart

# 8. AUTO-UPGRADE SETUP
RUN printf "#!/bin/bash\n\
    printf \"--- Upgrade gestart op \$(date) ---\n\" >> /var/log/vtuber_upgrade.log\n\
    cd /app\n\
    yes | python3 upgrade.py >> /var/log/vtuber_upgrade.log 2>&1\n\
    printf \"Herstarten van server-service na upgrade...\n\" >> /var/log/vtuber_upgrade.log\n\
    pkill -f run_server.py\n" > /usr/local/bin/auto-upgrade.sh && \
        chmod +x /usr/local/bin/auto-upgrade.sh

# Voeg de cronjob toe
RUN printf "0 4 * * 0 root /usr/local/bin/auto-upgrade.sh\n" > /etc/cron.d/vtuber-upgrade && \
    chmod 0644 /etc/cron.d/vtuber-upgrade

# 9. Installeer Extra MCP voice asr/stt/tts models.
# WORKDIR /app/models
# RUN wget -c https://github.com/k2-fsa/sherpa-onnx/releases/download/asr-models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2024-07-17.tar.bz2 && tar xvf "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2024-07-17.tar.bz2" && rm "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2024-07-17.tar.bz2"

# RUN wget -c https://github.com/k2-fsa/sherpa-onnx/releases/download/asr-models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2025-09-09.tar.bz2 && tar xvf "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2025-09-09.tar.bz2" && rm "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2025-09-09.tar.bz2"

# 10. Installeer Extra MCP server/clients.
RUN git clone https://github.com/nbhansen/retroMCP.git /opt/retroMCP
WORKDIR /opt/retroMCP
# RUN uv sync
# RUN source venv/bin/activate
RUN uv pip install -e .

EXPOSE 12393 3000 3001

