# Gebruik een Ubuntu-gebaseerde webtop voor de beste compatibiliteit
FROM lscr.io/linuxserver/webtop:ubuntu-kde
# Base image
FROM nvidia/cuda:12.6.0-cudnn-runtime-ubuntu22.04 AS base

# Voorkom interactieve prompts tijdens installatie
ENV DEBIAN_FRONTEND=noninteractive

# 1. Installeer CUDA 12.1 + Build Tools (Nodig voor sommige Python packages)
# wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb
# wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
RUN apt-get update && apt-get install -y wget gnupg2 curl && \
    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb && \
    dpkg -i cuda-keyring_1.1-1_all.deb && \
    rm -rf /var/lib/apt/lists/* cuda-keyring_1.1-1_all.deb

# RUN apt-get update && apt-get install -y \
#     cuda-nvrtc-13-1 \
#     cuda-cudart-13-1 \
#     libcudnn8 && \
#     rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y \
    python3-pip python3-dev \
    git wget gnupg2 curl libportaudio2 libasound2-dev \
    portaudio19-dev build-essential gcc g++ && \
    rm -rf /var/lib/apt/lists/*

# Update and install dependencies
RUN apt-get -o Acquire::AllowInsecureRepositories=true update && \
    apt-get install -y libxcb-xfixes0 libxcb-shape0 || true && \
    apt-get install -y --no-install-recommends ffmpeg || true && \
    apt --fix-broken install -y && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Copy requirements and install common dependencies
COPY requirements.txt /tmp/

# # 2. Installeer 'uv' via de officiÃ«le installer
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# Install pip
ARG USE_PIP=true

SHELL ["/bin/bash", "-o", "pipefail", "-c"]
RUN if [ "$USE_PIP" = "true" ]; then \
        curl https://bootstrap.pypa.io/get-pip.py | python3 - && \
        pip install --root-user-action=ignore --no-cache-dir -r /tmp/requirements.txt && \
        pip install --root-user-action=ignore --no-cache-dir funasr modelscope huggingface_hub pywhispercpp torch torchaudio edge-tts azure-cognitiveservices-speech py3-tts; \
    else \
        uv pip install --root-user-action=ignore --no-cache-dir -r /tmp/requirements.txt && \
        uv pip install --root-user-action=ignore --no-cache-dir funasr modelscope huggingface_hub pywhispercpp torch torchaudio edge-tts azure-cognitiveservices-speech py3-tts; \
    fi

# MeloTTS installation
WORKDIR /opt/MeloTTS
RUN if [ "$USE_PIP" = "true" ]; then \
        git clone https://github.com/myshell-ai/MeloTTS.git /opt/MeloTTS && \
        pip install --root-user-action=ignore --no-cache-dir -e . && \
        python3 -m unidic download && \
        python3 melo/init_downloads.py; \
    else; \
        git clone https://github.com/myshell-ai/MeloTTS.git /opt/MeloTTS && \
        uv pip install --root-user-action=ignore --no-cache-dir -e . && \
        uv run python3 -m unidic download && \
        uv run python3 melo/init_downloads.py; \
    fi

# Whisper variant
FROM base AS whisper
ARG INSTALL_ORIGINAL_WHISPER=false
RUN if [ "$USE_PIP" = "true" ] && [ "$INSTALL_WHISPER" = "true" ]; then \
        pip install --root-user-action=ignore --no-cache-dir openai-whisper; \
    else; \
        uv pip install --root-user-action=ignore --no-cache-dir openai-whisper; \
    fi

# Bark variant
FROM whisper AS bark
ARG INSTALL_BARK=false
RUN if [ "$USE_PIP" = "true" ] &&  [ "$INSTALL_BARK" = "true" ]; then \
        pip install --root-user-action=ignore --no-cache-dir git+https://github.com/suno-ai/bark.git; \
    else; \
        uv pip install --root-user-action=ignore --no-cache-dir git+https://github.com/suno-ai/bark.git; \
    fi

# Final image
FROM bark AS final

COPY . /app

# Set working directory
WORKDIR /app

# # 3. Clone de repo
# RUN git clone --recursive https://github.com/Open-LLM-VTuber/Open-LLM-VTuber.git /app/openllm-vtuber

# RUN uv sync --all-extras
# RUN uv sync --all-extras --frozen --no-dev

# 4. Installeer dependencies met 'uv'
# We voegen --verbose toe zodat we precies zien welk pakket faalt als het weer misgaat
# RUN uv pip install --system --break-system-packages --no-cache --verbose -r requirements.txt
# RUN uv pip install py3-tts sherpa-onnx fish-audio-sdk unidic-lite mecab-python3

# --- AUTORUN SETUP ---
# 6. Maak een init-script voor de autostart
# Kopieer het script naar de custom services map van LinuxServer.io

# COPY autostart.sh /custom-services.d/vtuber
# RUN chmod +x /custom-services.d/vtuber

# COPY autostart.sh /etc/cont-init.d/99-vtuber-start
# RUN chmod +x /etc/cont-init.d/99-vtuber-start

# RUN usermod -aG audio abc

CMD ["python3", "server.py"]

EXPOSE 12393 3000 3001

