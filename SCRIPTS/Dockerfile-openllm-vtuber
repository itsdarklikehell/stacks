# Gebruik een Ubuntu-gebaseerde webtop voor de beste compatibiliteit
FROM lscr.io/linuxserver/webtop:ubuntu-kde
# FROM nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

# Voorkom interactieve prompts tijdens installatie
ENV DEBIAN_FRONTEND=noninteractive

# 1. Installeer CUDA 12.1 via de officiële keyring methode
RUN apt-get update && apt-get install -y wget gnupg2 curl && \
    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb && \
    dpkg -i cuda-keyring_1.1-1_all.deb && \
    apt-get update && apt-get install -y \
    cuda-nvrtc-12-1 \
    cuda-cudart-12-1 \
    libcudnn8 \
    python3-pip python3-dev ffmpeg git libportaudio2 \
    && rm -rf /var/lib/apt/lists/* cuda-keyring_1.1-1_all.deb

# 2. Installeer 'uv' via de officiële installer
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

WORKDIR /app

# 3. Clone de repo en 4. Installeer dependencies met 'uv'
RUN git clone --recursive https://github.com/Open-LLM-VTuber/Open-LLM-VTuber.git . && uv pip install --system --no-cache -r requirements.txt

# 5. Maak een init-script voor de autostart
COPY autostart.sh /etc/cont-init.d/99-vtuber-start
RUN chmod +x /etc/cont-init.d/99-vtuber-start

EXPOSE 12393 3000 3001

