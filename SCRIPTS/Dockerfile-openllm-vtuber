# 1. Gebruik Webtop als basis
FROM lscr.io/linuxserver/webtop:ubuntu-kde

# Voorkom interactieve prompts
ENV DEBIAN_FRONTEND=noninteractive

# 2. Systeem dependencies + CUDA Repo
RUN apt-get update && apt-get install -y wget gnupg2 curl ca-certificates && \
    wget https://developer.download.nvidia.com && \
    dpkg -i cuda-keyring_1.1-1_all.deb && \
    apt-get update && \
    apt-get install -y \
    cuda-nvrtc-12-1 \
    cuda-cudart-12-1 \
    libcudnn8 \
    python3-pip python3-venv python3-dev cmake \
    build-essential gcc g++ ffmpeg libmecab-dev git cron && \
    rm -rf /var/lib/apt/lists/* cuda-keyring_1.1-1_all.deb

# 3. Installeer 'uv' via de officiÃ«le binary
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# 4. Maak een Virtual Environment (VENV) - DIT VOORKOMT DE KDE CRASH
# We gebruiken /opt/venv zodat de systeem-python van KDE veilig blijft
RUN uv venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"
# Geen UV_SYSTEM_PYTHON=1 meer gebruiken!

# 5. Python installatie in de Venv
COPY requirements.txt /tmp/
RUN uv pip install --index-url https://download.pytorch.org \
    torch==2.5.1 torchaudio==2.5.1 && \
    grep -vE "torch|torchaudio|sherpa-onnx|edge-tts" /tmp/requirements.txt > /tmp/req_cleaned.txt && \
    uv pip install -r /tmp/req_cleaned.txt && \
    uv pip install sherpa-onnx funasr modelscope huggingface_hub pywhispercpp "edge-tts==7.2.1" azure-cognitiveservices-speech py3-tts

# 6. MeloTTS installatie
WORKDIR /opt/MeloTTS
RUN git clone https://github.com . && \
    uv pip install "numpy<2.0.0" && \
    uv pip install "tokenizers>=0.19" "transformers>=4.40" "setuptools>=65" \
    "Cython" "fugashi" "unidic" "unidic-lite" "mecab-python3" \
    "cn2an" "py3-tts" "jieba" "pypinyin" "anyascii" "librosa" \
    "scipy" "jamo" "num2words" "tiktoken" "inflect" "pykakasi" \
    "g2p_en" "gruut" "gruut-lang-en" "gruut-lang-fr" "gruut-lang-de" "gruut-lang-es" \
    "cached-path" "alt-profanity-check" && \
    uv pip install --no-deps -e . && \
    python3 -m unidic download && \
    python3 melo/init_downloads.py

# 7. App setup
WORKDIR /app
COPY . /app

# # 8. Extra Modellen (SenseVoice)
# WORKDIR /app/models
# RUN wget -c https://github.com/k2-fsa/sherpa-onnx/releases/download/asr-models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2024-07-17.tar.bz2 && \
#     tar xvf "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2024-07-17.tar.bz2" && \
#     rm "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2024-07-17.tar.bz2" && \
#     wget -c https://github.com/k2-fsa/sherpa-onnx/releases/download/asr-models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2025-09-09.tar.bz2 && \
#     tar xvf "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2025-09-09.tar.bz2" && \
#     rm "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2025-09-09.tar.bz2"

# # 9. RetroMCP installatie
# RUN git clone https://github.com/nbhansen/retroMCP.git /opt/retroMCP && \
#     cd /opt/retroMCP && uv pip install -e .

WORKDIR /config

# RUN mkdir -p /config/.kasms/ && \
#     printf "encoding:\n  audio: true\n  audio_fixed: true\n" > /config/.kasms/kasmvnc.yaml && \
#     chown -R 1000:1000 /config/.kasms/

EXPOSE 3000 3001 12393

