# 1. Gebruik een officiële slanke CUDA base
FROM nvidia/cuda:12.1.1-runtime-ubuntu22.04

# 2. Systeem dependencies (geen GUI, alleen de engine)
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    git curl ffmpeg libmecab-dev python3-pip python3-venv \
    && rm -rf /var/lib/apt/lists/*

# 3. Installeer 'uv' voor razendsnelle installatie
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# 4. App & VENV setup
WORKDIR /app
RUN uv venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# 5. Open-LLM-VTuber broncode ophalen
RUN git clone https://github.com/Open-LLM-VTuber/Open-LLM-VTuber.git --recursive . && \
    # Patch alle versie-eisen die build-errors veroorzaken
    find . -type f -exec sed -i 's/sherpa-onnx==[0-9.]*/sherpa-onnx/g' {} + && \
    # Installeer het project en de TTS backends
    uv pip install . edge-tts

# 6. MeloTTS installatie (Geïsoleerd in de venv)
WORKDIR /opt/MeloTTS
RUN git clone https://github.com/myshell-ai/MeloTTS.git --recursive . && \
    find . -type f -exec sed -i 's/transformers==[0-9.]*/transformers>=4.40/g' {} + && \
    find . -type f -exec sed -i 's/tokenizers==[0-9.]*/tokenizers>=0.19/g' {} + && \
    uv pip install "tokenizers>=0.19" "transformers>=4.40" onnxruntime-gpu && \
    uv pip install -e . && \
    python3 -m unidic download

# 7. Terug naar app en poorten openzetten
WORKDIR /app
EXPOSE 12393

# Start de server direct
CMD ["python3", "run_server.py"]
