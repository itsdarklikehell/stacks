# 1. Gebruik Webtop als basis
FROM lscr.io/linuxserver/webtop:ubuntu-kde

# Voorkom interactieve prompts
ENV DEBIAN_FRONTEND=noninteractive

# 2. Systeem dependencies + CUDA Repo
RUN apt-get update && apt-get install -y wget gnupg2 curl ca-certificates && \
    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb && \
    dpkg -i cuda-keyring_1.1-1_all.deb && \
    apt-get update && \
    apt-get install -y cuda-nvrtc-12-1 cuda-cudart-12-1 libcudnn8 \
    python3-pip python3-venv python3-dev cmake build-essential gcc g++ ffmpeg libmecab-dev git cron libusb-1.0-0 && \
    rm -rf /var/lib/apt/lists/* cuda-keyring_1.1-1_all.deb

# 3. Installeer 'uv' via de officiÃ«le binary
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# 4. Maak een Virtual Environment (VENV)
RUN uv venv /opt/venv
ENV VIRTUAL_ENV="/opt/venv"
ENV PATH="/opt/venv/bin:$PATH"

# 5. Open-LLM-VTuber installatie
WORKDIR /app
RUN git clone https://github.com/Open-LLM-VTuber/Open-LLM-VTuber.git --recursive . && \
    # Verwijder versie-eis sherpa-onnx en installeer
    sed -i 's/sherpa-onnx==[0-9.]*/sherpa-onnx/g' requirements.txt && \
    uv pip install -r requirements.txt

# 6. MeloTTS installatie (De Fix)
WORKDIR /opt/MeloTTS
RUN git clone https://github.com/myshell-ai/MeloTTS.git . && \
    # Forceer moderne tokenizers/transformers VOORDAT MeloTTS installeert
    uv pip install "tokenizers>=0.19" "transformers>=4.40" && \
    uv pip install -e . && \
    python3 -m unidic download && \
    python3 melo/init_downloads.py

# 10. S6 Services (Automatisering)
RUN mkdir -p /etc/services.d/vtuber-server && \
        printf "#!/bin/bash\ncd /app\nexec /opt/venv/bin/python3 main.py\n" > /etc/services.d/vtuber-server/run && \
        chmod +x /etc/services.d/vtuber-server/run

# Browser Autostart op poort 12393 (Web Mode)
RUN mkdir -p /custom-cont-init.d && \
        printf "#!/bin/bash\n( until curl -s http://localhost:12393 > /dev/null; do sleep 2; done; export DISPLAY=:1; sudo -u abc chromium --no-sandbox --autoplay-policy=no-user-gesture-required http://localhost:12393 ) &\n" > /custom-cont-init.d/99-start-browser && \
        chmod +x /custom-cont-init.d/99-start-browser

WORKDIR /config
EXPOSE 3000 3001 12393