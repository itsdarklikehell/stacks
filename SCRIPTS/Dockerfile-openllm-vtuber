# Gebruik een Ubuntu-gebaseerde webtop voor de beste compatibiliteit
FROM lscr.io/linuxserver/webtop:ubuntu-kde
# FROM nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

# Voorkom interactieve prompts tijdens installatie
ENV DEBIAN_FRONTEND=noninteractive

# 1. Installeer CUDA 12.1 + Build Tools (Nodig voor sommige Python packages)
# wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb
# wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
# RUN apt-get update && apt-get install -y wget gnupg2 curl && \
#     wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb && \
#     dpkg -i cuda-keyring_1.1-1_all.deb && \
#     apt-get update && apt-get install -y \
#     cuda-nvrtc-13-1 \
#     cuda-cudart-13-1 \
#     libcudnn8 && \
#     rm -rf /var/lib/apt/lists/* cuda-keyring_1.1-1_all.deb

RUN apt-get update && apt-get install -y \
    python3-pip python3-dev ffmpeg \
    git libportaudio2 libasound2-dev \
    portaudio19-dev build-essential gcc g++ && \
    rm -rf /var/lib/apt/lists/*

# 2. Installeer 'uv' via de officiÃ«le installer
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

WORKDIR /app

# 3. Clone de repo
RUN git clone --recursive https://github.com/Open-LLM-VTuber/Open-LLM-VTuber.git /app/openllm-vtuber

WORKDIR /app/openllm-vtuber

# RUN uv sync --all-extras
RUN uv sync --all-extras --frozen --no-dev

# 4. Installeer dependencies met 'uv'
# We voegen --verbose toe zodat we precies zien welk pakket faalt als het weer misgaat
# RUN uv pip install --system --break-system-packages --no-cache --verbose -r requirements.txt
# RUN uv pip install py3-tts sherpa-onnx fish-audio-sdk unidic-lite mecab-python3

# # 5. (Optioneel) Installeer MeloTTS en Bark
# RUN apt-get update && apt-get install -y py3-tts sherpa-onnx \
#     fish-audio-sdk unidic-lite mecab-python3 && \
#     rm -rf /var/lib/apt/lists/*
# RUN uv add git+https://github.com/myshell-ai/MeloTTS.git && \
#     uv pip install git+https://github.com/myshell-ai/MeloTTS.git
# RUN uv add git+https://github.com/suno-ai/bark.git && \
#     uv pip install git+https://github.com/suno-ai/bark.git
# RUN uv pip install unidic
# RUN python -m unidic download >/dev/null 2>&1 &
# RUN cat >/tmp/import_nltk.py <<EOF
# import nltk
# nltk.download('averaged_perceptron_tagger_eng')
# EOF

# RUN python3 /tmp/import_nltk.py && rm /tmp/import_nltk.py
# RUN uv run /tmp/import_nltk.py && rm /tmp/import_nltk.py

# 6. Maak een init-script voor de autostart
COPY autostart.sh /etc/cont-init.d/99-vtuber-start
RUN chmod +x /etc/cont-init.d/99-vtuber-start

RUN usermod -aG audio abc

EXPOSE 12393 3000 3001

