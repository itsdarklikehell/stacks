# 1. Gebruik Webtop als basis (Ubuntu-KDE)
FROM lscr.io/linuxserver/webtop:ubuntu-kde

# Voorkom interactieve prompts
ENV DEBIAN_FRONTEND=noninteractive

# 2. Systeem dependencies + CUDA 12.1 repositories
RUN apt-get update && apt-get install -y wget gnupg2 curl ca-certificates && \
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb && \
dpkg -i cuda-keyring_1.1-1_all.deb && \
apt-get update && \
apt-get install -y \
cuda-nvrtc-12-1 \
cuda-cudart-12-1 \
libcudnn8 \
python3-pip python3-dev cmake \
git libportaudio2 libasound2-dev \
portaudio19-dev build-essential gcc g++ ffmpeg libmecab-dev cron && \
rm -rf /var/lib/apt/lists/* cuda-keyring_1.1-1_all.deb

# 3. Installeer 'uv' via de officiÃ«le binary
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# 4. Python installatie
COPY requirements.txt /tmp/
ENV UV_SYSTEM_PYTHON=1

RUN rm -f /usr/lib/python3.12/EXTERNALLY-MANAGED && \
# Installeer Torch + Torchaudio SAMEN uit de CUDA index
uv pip install \
--index-url https://download.pytorch.org/whl/cu124 \
torch==2.5.1 torchaudio==2.5.1 && \
grep -vE "torch|torchaudio|sherpa-onnx|edge-tts" /tmp/requirements.txt > /tmp/req_cleaned.txt && \
uv pip install -r /tmp/req_cleaned.txt && \
# FIX: Installeer versie 7.2.1 om de "No audio received" fout te herstellen
uv pip install sherpa-onnx funasr modelscope huggingface_hub pywhispercpp "edge-tts==7.2.1" azure-cognitiveservices-speech py3-tts

# 5. MeloTTS installatie
WORKDIR /opt/MeloTTS
RUN git clone https://github.com/myshell-ai/MeloTTS.git /opt/MeloTTS && \
uv pip install "numpy<2.0.0" && \
uv pip install \
"tokenizers>=0.19" "transformers>=4.40" "setuptools>=65" \
"Cython" "fugashi" "unidic" "unidic-lite" "mecab-python3" \
"cn2an" "py3-tts" "jieba" "pypinyin" "anyascii" "librosa" \
"scipy" "jamo" "num2words" "tiktoken" "inflect" "pykakasi" \
"g2p_en" "gruut" "gruut-lang-en" "gruut-lang-fr" "gruut-lang-de" "gruut-lang-es" \
"cached-path" "alt-profanity-check" && \
uv pip install --no-deps -e . && \
python3 -m unidic download && \
python3 melo/init_downloads.py

# 6. App setup & KasmVNC Audio Force
WORKDIR /app
COPY . /app
# Forceer de KasmVNC audio settings (dit helpt bij de standaard status)
RUN mkdir -p /config/.kasms/ && \
echo "encoding:" > /config/.kasms/kasmvnc.yaml && \
echo "  audio: true" >> /config/.kasms/kasmvnc.yaml && \
echo "  audio_fixed: true" >> /config/.kasms/kasmvnc.yaml && \
chown -R 1000:1000 /config/.kasms/

# 7a. SERVER SERVICE (Draait op de achtergrond, s6-init houdt dit in de gaten)
RUN mkdir -p /custom-services.d && \
echo "#!/bin/bash\n\
cd /app\n\
exec python3 run_server.py" > /custom-services.d/vtuber-server && \
chmod +x /custom-services.d/vtuber-server

# 7b. BROWSER AUTOSTART (Via custom-init om volume-mounts te overleven)
RUN mkdir -p /custom-cont-init.d && \
echo "#!/bin/bash\n\
mkdir -p /config/.config/autostart\n\
echo \"[Desktop Entry]\n\
Type=Application\n\
Name=VTuber-Kiosk\n\
Exec=bash -c 'sleep 20 && (chromium --no-first-run --use-fake-ui-for-media-stream --autoplay-policy=no-user-gesture-required --unsafely-treat-insecure-origin-as-secure=http://localhost:12393 --user-data-dir=/config/.config/chromium --password-store=basic http://localhost:12393 https://app.letta.com/settings/organization/projects?view-mode=selfHosted)'\n\" > /config/.config/autostart/vtuber-browser.desktop\n\
chown -R 1000:1000 /config/.config" > /custom-cont-init.d/setup-browser.sh && \
chmod +x /custom-cont-init.d/setup-browser.sh

# 8. AUTO-UPGRADE SETUP (Wekelijkse cron + automatische herstart via s6)
RUN echo "#!/bin/bash\n\
echo \"--- Upgrade gestart op \$(date) ---\" >> /var/log/vtuber_upgrade.log\n\
cd /app\n\
# 1. Update uitvoeren\n\
yes | python3 upgrade.py >> /var/log/vtuber_upgrade.log 2>&1\n\
\n\
# 2. Server 'killen' - s6-init herstart hem daarna automatisch\n\
echo \"Herstarten van server-service na upgrade...\" >> /var/log/vtuber_upgrade.log\n\
pkill -f run_server.py" > /usr/local/bin/auto-upgrade.sh && \
chmod +x /usr/local/bin/auto-upgrade.sh

# Voeg de cronjob toe (Elke zondag om 04:00)
RUN echo "0 4 * * 0 root /usr/local/bin/auto-upgrade.sh" > /etc/cron.d/vtuber-upgrade && \
chmod 0644 /etc/cron.d/vtuber-upgrade

EXPOSE 12393 3000 3001

