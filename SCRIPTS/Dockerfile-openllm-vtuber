# 1. Gebruik Webtop als basis (Ubuntu-KDE)
FROM lscr.io/linuxserver/webtop:ubuntu-kde

# Voorkom interactieve prompts
ENV DEBIAN_FRONTEND=noninteractive

# 2. Systeem dependencies + CUDA 12.1 repositories
RUN apt-get update && apt-get install -y wget gnupg2 curl ca-certificates && \
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb && \
dpkg -i cuda-keyring_1.1-1_all.deb && \
apt-get update && \
apt-get install -y \
cuda-nvrtc-12-1 \
cuda-cudart-12-1 \
libcudnn8 \
python3-pip python3-dev cmake \
git libportaudio2 libasound2-dev \
portaudio19-dev build-essential gcc g++ ffmpeg libmecab-dev cron xdg-utils firefox && \
rm -rf /var/lib/apt/lists/* cuda-keyring_1.1-1_all.deb

# 3. Installeer 'uv' via de officiÃ«le binary
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# 4. Python installatie
COPY requirements.txt /tmp/
ENV UV_SYSTEM_PYTHON=1

RUN rm -f /usr/lib/python3.12/EXTERNALLY-MANAGED && \
# Installeer Torch + Torchaudio SAMEN uit de CUDA index
uv pip install --no-cache-dir \
--index-url https://download.pytorch.org/whl/cu124 \
torch==2.5.1 torchaudio==2.5.1 && \
# Installeer de rest
grep -vE "torch|torchaudio|sherpa-onnx" /tmp/requirements.txt > /tmp/req_cleaned.txt && \
uv pip install --no-cache-dir -r /tmp/req_cleaned.txt && \
uv pip install --no-cache-dir sherpa-onnx funasr modelscope huggingface_hub pywhispercpp edge-tts azure-cognitiveservices-speech py3-tts

# 5. MeloTTS installatie
WORKDIR /opt/MeloTTS
RUN git clone https://github.com/myshell-ai/MeloTTS.git /opt/MeloTTS && \
# 1. Eerst numpy
uv pip install --no-cache-dir "numpy<2.0.0" && \
# 2. De cleaners inclusief g2p_en en taal-specifieke gruut pakketten
uv pip install --no-cache-dir \
"tokenizers>=0.19" "transformers>=4.40" "setuptools>=65" \
"Cython" "fugashi" "unidic" "unidic-lite" "mecab-python3" \
"cn2an" "py3-tts" "jieba" "pypinyin" "anyascii" "librosa" \
"scipy" "jamo" "num2words" "tiktoken" "inflect" "pykakasi" \
"g2p_en" "gruut" "gruut-lang-en" "gruut-lang-fr" "gruut-lang-de" "gruut-lang-es" \
"cached-path" "alt-profanity-check" && \
# 3. MeloTTS zelf
uv pip install --no-cache-dir --no-deps -e . && \
# 4. Data download
python3 -m unidic download && \
python3 melo/init_downloads.py

# 6. App setup & Rechten
WORKDIR /app
COPY . /app
RUN chown -R 1000:1000 /app /opt/MeloTTS /config

# 7. AUTORUN SETUP (Server + Browser)
RUN mkdir -p /custom-services.d && \
echo "#!/bin/bash\n\
cd /app\n\
python3 run_server.py &\n\
sleep 15\n\
export DISPLAY=:1\n\
sudo -u abc xdg-open http://localhost:12393 >/dev/null 2>&1 &" > /custom-services.d/vtuber-start.sh && \
chmod +x /custom-services.d/vtuber-start.sh

# # 8. AUTO-UPGRADE SETUP (Wekelijkse cron + herstart)
# RUN echo "#!/bin/bash\n\
# echo \"--- Upgrade gestart op \$(date) ---\" >> /var/log/vtuber_upgrade.log\n\
# cd /app\n\
# # 1. Update uitvoeren (beantwoordt alle vragen met 'yes')\n\
# yes | python3 upgrade.py >> /var/log/vtuber_upgrade.log 2>&1\n\
# \n\
# # 2. Server herstarten\n\
# echo \"Herstarten van server...\" >> /var/log/vtuber_upgrade.log\n\
# # Zoek het proces-id van de oude server en sluit deze af\n\
# pkill -f run_server.py\n\
# sleep 5\n\
# # Start de server opnieuw op (Display is nodig voor Firefox integratie)\n\
# export DISPLAY=:1\n\
# python3 run_server.py --verbose >> /var/log/vtuber_server.log 2>&1 &" > /usr/local/bin/auto-upgrade.sh && \
# chmod +x /usr/local/bin/auto-upgrade.sh

# # Voeg de cronjob toe (Elke zondag om 04:00)
# RUN echo "0 4 * * 0 root /usr/local/bin/auto-upgrade.sh" > /etc/cron.d/vtuber-upgrade && \
# chmod 0644 /etc/cron.d/vtuber-upgrade

EXPOSE 12393 3000 3001
