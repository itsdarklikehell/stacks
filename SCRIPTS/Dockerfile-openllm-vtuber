# 1. Gebruik Webtop als basis
FROM lscr.io/linuxserver/webtop:ubuntu-kde

# Voorkom interactieve prompts
ENV DEBIAN_FRONTEND=noninteractive

# 2. Systeem dependencies + CUDA Repo
RUN apt-get update && apt-get install -y wget gnupg2 curl ca-certificates && \
    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb && \
    dpkg -i cuda-keyring_1.1-1_all.deb && \
    apt-get update && \
    apt-get install -y cuda-nvrtc-12-1 cuda-cudart-12-1 libcudnn8 \
    python3-pip python3-venv python3-dev cmake build-essential gcc g++ ffmpeg libmecab-dev git cron libusb-1.0-0 && \
    rm -rf /var/lib/apt/lists/* cuda-keyring_1.1-1_all.deb

# 3. Installeer 'uv' via de officiële binary
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# 4. Maak een Virtual Environment (VENV)
RUN uv venv /opt/venv
ENV VIRTUAL_ENV="/opt/venv"
ENV PATH="/opt/venv/bin:$PATH"

# 5. Open-LLM-VTuber installatie
WORKDIR /app
RUN git clone https://github.com/Open-LLM-VTuber/Open-LLM-VTuber.git --recursive . && \
    sed -i 's/sherpa-onnx==[0-9.]*/sherpa-onnx/g' requirements.txt && \
    uv pip install -r requirements.txt
# OR: COPY . /app

# 6. EXTRA: ASR Backend Dependencies & Whisper-live
# We voegen libcublas12 toe voor GPU versnelling en portaudio voor streaming
RUN apt-get update && apt-get install -y libcublas12 portaudio19-dev libasound2-dev && \
    uv pip install faster-whisper funasr whisper-live pyaudio shell-command-launcher

# 7. Sherpa-ONNX & SenseVoice Integratie (Zoals in de docs)
# SenseVoiceSmall is extreem snel en goed in emotie-detectie
WORKDIR /app/models
RUN wget -q https://github.com/k2-fsa/sherpa-onnx/releases/download/asr-models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2024-07-17.tar.bz2 && \
    tar xvf "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2024-07-17.tar.bz2" && \
    rm "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2024-07-17.tar.bz2"
# WORKDIR /app/models
# RUN wget -q https://github.com/k2-fsa/sherpa-onnx/releases/download/asr-models/sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2025-09-09.tar.bz2 && \
#     tar xvf "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2025-09-09.tar.bz2" && \
#     rm "sherpa-onnx-sense-voice-zh-en-ja-ko-yue-int8-2025-09-09.tar.bz2"

# 8. MeloTTS installatie
WORKDIR /opt/MeloTTS
RUN git clone https://github.com/myshell-ai/MeloTTS.git . && \
    # Forceer ALLE bestanden (setup.py én requirements.txt) naar moderne versies
    find . -type f -exec sed -i 's/transformers==[0-9.]*/transformers>=4.40/g' {} + && \
    find . -type f -exec sed -i 's/tokenizers==[0-9.]*/tokenizers>=0.19/g' {} + && \
    # Installeer eerst de lastige jongens los in de venv
    uv pip install "tokenizers>=0.19" "transformers>=4.40" "onnxruntime-gpu" && \
    # Installeer nu de rest van MeloTTS
    uv pip install -e . && \
    python3 -m unidic download && \
    python3 melo/init_downloads.py

# 9. S6 Services (Automatisering)
RUN mkdir -p /etc/services.d/vtuber-server && \
        printf "#!/bin/bash\ncd /app\nexec /opt/venv/bin/python3 main.py\n" > /etc/services.d/vtuber-server/run && \
        chmod +x /etc/services.d/vtuber-server/run

# 10. Browser Autostart op poort 12393 (Web Mode)
RUN mkdir -p /custom-cont-init.d && \
        printf "#!/bin/bash\n( until curl -s http://localhost:12393 > /dev/null; do sleep 2; done; export DISPLAY=:1; sudo -u abc chromium --no-sandbox --autoplay-policy=no-user-gesture-required http://localhost:12393 ) &\n" > /custom-cont-init.d/99-start-browser && \
        chmod +x /custom-cont-init.d/99-start-browser

WORKDIR /config
EXPOSE 3000 3001 9090 12393