FROM python:3.11-slim

# System dependencies for audio analysis, conversion and building
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libfftw3-dev \
    libyaml-dev \
    libsamplerate0-dev \
    build-essential \
    pkg-config \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install Python requirements
# essentia-tensorflow provides the pre-trained models for analysis
RUN pip install --no-cache-dir \
    essentia-tensorflow \
    pydub \
    ollama \
    numpy \
    librosa \
    sf2utils

# Copy the sorter script
COPY pico_sorter.py .

# Ensure /tmp exists for temporary file processing
RUN mkdir -p /tmp && chmod 777 /tmp

# Unbuffered output to see progress in Docker logs
CMD ["python", "-u", "pico_sorter.py"]
