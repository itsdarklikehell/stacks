# 1. Gebruik de UV builder om de binary te lenen
FROM ghcr.io/astral-sh/uv:latest AS uv_bin

# 2. Gebruik de NVIDIA runtime (Ubuntu 22.04 + CUDA 12.1)
FROM nvidia/cuda:12.1.1-runtime-ubuntu22.04

# 3. Omgevingsvariabelen instellen
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    UV_SYSTEM_PYTHON=1 \
    UV_HTTP_TIMEOUT=300 \
    PYTHONPATH="/ComfyUI"

# 4. Kopieer uv binaries van de builder stage
COPY --from=uv_bin /uv /uvx /bin/

# 5. Installeer systeem-dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.10 \
    python3-pip \
    python-is-python3 \
    git \
    curl \
    ca-certificates \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# 6. Stel de werkmap in op /ComfyUI
WORKDIR /ComfyUI

# STAP 1: Installeer PyTorch (grootste laag, apart voor caching)
RUN uv pip install --no-cache \
    torch torchvision torchaudio \
    --extra-index-url https://download.pytorch.org/whl/cu121

# STAP 2: Clone ComfyUI core naar de huidige map (.)
RUN git clone --recursive https://github.com/Comfy-Org/ComfyUI.git . && \
    uv pip install --no-cache -r requirements.txt

# STAP 3: Installeer ComfyUI-Manager
RUN mkdir -p custom_nodes/ComfyUI-Manager && \
    git clone --recursive https://github.com/Comfy-Org/ComfyUI-Manager.git custom_nodes/ComfyUI-Manager && \
    uv pip install --no-cache -r custom_nodes/ComfyUI-Manager/requirements.txt

# STAP 4: Installeer Comfy-CLI en configureer de workspace
# We slaan --install-completion over omdat dit niet werkt in Docker (sh)
# We gebruiken 'yes n' om de tracking prompt bij 'set-default' te passeren
RUN uv pip install --no-cache comfy-cli && \
    yes y | comfy set-default /ComfyUI

# STAP 5: Gezondheidscontrole
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8188/system_stats || exit 1

# STAP 6: Poort openzetten
EXPOSE 8188

# STAP 7: Start ComfyUI
# De '--' zorgt dat de argumenten daarna direct naar ComfyUI gaan
# CMD ["python3", "main.py", "--listen", "0.0.0.0"]
CMD ["comfy", "launch", "--", "--listen", "0.0.0.0"]
