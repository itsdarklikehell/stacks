# Gebruik de UV builder om de binary te lenen
FROM ghcr.io/astral-sh/uv:latest AS uv_bin

# Gebruik de juiste NVIDIA base voor GPU support
FROM nvidia/cuda:12.1.1-base-ubuntu22.04

# Argumenten voor user management
ARG UID=1000
ARG GID=1000

# Omgevingsvariabelen
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    UV_HTTP_TIMEOUT=300 \
    UV_SYSTEM_PYTHON=1 \
    PATH="/home/comfyuser/.local/bin:$PATH"

# Kopieer uv naar de nieuwe image
COPY --from=uv_bin /uv /uvx /bin/

# Systeem-dependencies installeren als ROOT
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.10 \
    python3-pip \
    git \
    libgl1-mesa-glx \
    libglib2.0-0 \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Gebruiker aanmaken en directory structuur opzetten
RUN groupadd -g $GID comfyuser && \
    useradd -u $UID -g $GID -m comfyuser && \
    mkdir -p /ComfyUI && \
    chown -R comfyuser:comfyuser /ComfyUI

# STAP 1: Installeer zware dependencies als ROOT om permissiefouten te voorkomen
# We gebruiken --no-cache om de uiteindelijke image klein te houden
RUN uv pip install --no-cache \
    comfy-cli \
    torch torchvision torchaudio \
    --extra-index-url https://download.pytorch.org/whl/cu121

# STAP 2: Wissel naar de veilige gebruiker voor de rest van de setup
USER comfyuser
WORKDIR /ComfyUI

# Installeer ComfyUI via de CLI in de huidige map
RUN yes | comfy set-default /ComfyUI && \
    yes | comfy --install-completion && \
    yes | comfy --workspace=/ComdfyUI install

# Gezondheidscontrole
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8188/system_stats || exit 1

EXPOSE 8188

# Start met listen op 0.0.0.0 zodat Docker de poort kan mappen
CMD ["comfy", "launch", "--", "--listen", "0.0.0.0"]
