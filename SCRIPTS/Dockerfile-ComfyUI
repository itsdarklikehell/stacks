# Gebruik de UV builder om de binary te lenen
FROM ghcr.io/astral-sh/uv:latest AS uv_bin

# Gebruik de juiste NVIDIA base voor GPU support
FROM nvidia/cuda:12.1.1-base-ubuntu22.04

# Argumenten voor user management
ARG UID=1000
ARG GID=1000

# Omgevingsvariabelen
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    UV_HTTP_TIMEOUT=300 \
    UV_SYSTEM_PYTHON=1

# Kopieer uv naar de nieuwe image
COPY --from=uv_bin /uv /uvx /bin/

# Systeem-dependencies installeren als ROOT
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.10 \
    python3-pip \
    python-is-python3 \
    git \
    libgl1-mesa-glx \
    libglib2.0-0 \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# STAP 1: Installeer zware dependencies als ROOT om permissiefouten te voorkomen
# We gebruiken --no-cache om de uiteindelijke image klein te houden
RUN uv pip install --no-cache \
    comfy-cli \
    torch torchvision torchaudio \
    --extra-index-url https://download.pytorch.org/whl/cu121

WORKDIR /ComfyUI

# Clone de officiÃ«le ComfyUI repository
RUN git clone --recursive https://github.com/Comfy-Org/ComfyUI.git /ComfyUI
# OPTIONEEL: Installeer de ComfyUI-Manager (aanbevolen)
RUN git clone --recursive https://github.com/Comfy-Org/ComfyUI-Manager.git /ComfyUI/custom_nodes/ComfyUI-Manager

# Installeer de Python requirements van ComfyUI
RUN uv pip install --no-cache -r requirements.txt

# Registreer de handmatige clone bij de CLI
RUN comfy set-default /ComfyUI
RUN comfy --workspace=/ComfyUI install --nvidia

# Gezondheidscontrole
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8188/system_stats || exit 1

EXPOSE 8188

# Start met listen op 0.0.0.0 zodat Docker de poort kan mappen
CMD ["comfy", "launch", "--", "--listen", "0.0.0.0"]
