# Gebruik een Python base image en installeer uv
FROM ghcr.io/astral-sh/uv:python3.10-slim-ubuntu22.04

ARG UID=1000
ARG GID=1000

ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    UV_COMPILE_BYTECODE=1

# Installeer systeem-afhankelijkheden en maak de gebruiker aan
RUN apt-get update && apt-get install -y \
    git libgl1-mesa-glx libglib2.0-0 curl \
    && rm -rf /var/lib/apt/lists/*

RUN groupadd -g $GID comfyuser && \
    useradd -u $UID -g $GID -m comfyuser

WORKDIR /ComfyUI

# Installeer comfy-cli als systeem-tool
RUN uv pip install --system comfy-cli

# Installeer PyTorch met uv (specifiek voor CUDA 12.1)
RUN uv pip install --system torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121

# Gebruik comfy-cli om ComfyUI te installeren
# --skip-prompt voorkomt interactieve vragen
# --here installeert in de huidige WORKDIR
RUN comfy --skip-prompt --here install --nvidia --fast-deps

# Rechten goedzetten voor de volumes
RUN chown -R $UID:$GID /ComfyUI

EXPOSE 8188

# Start ComfyUI met comfy-cli launch
CMD ["comfy", "launch", "--", "--listen", "0.0.0.0"]
