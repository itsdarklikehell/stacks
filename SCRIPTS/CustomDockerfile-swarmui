FROM mcr.microsoft.com/dotnet/sdk:8.0-bookworm-slim

ARG UID=1000

# Update and install dependencies
RUN apt-get update --no-instal-recommends && \
    apt-get install --no-instal-recommends -y libxcb-xfixes0 libxcb-shape0 pipx git wget curl ca-certificates python3 python3-venv ffmpeg git bzip2 && \
    apt-get --fix-broken --no-instal-recommends install -y && \
    apt-get --no-instal-recommends clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /Swarmui
# Copy swarm's files into the docker container
COPY . /SwarmUI

RUN chown -R $UID:$UID /SwarmUI

# Stupidproofing on git calls from inside docker
RUN git config --global --add safe.directory '*' && useradd -lu $UID swarmui

# If built binaries were copied in, discard them, they are likely bad.
# Build inside the container later (so eg extensions are included properly).
RUN rm -rf ./SwarmUI/src/bin ./SwarmUI/src/obj

# Expose the port for other containers (to use Swarm as an API if you want)
EXPOSE 7801

# Set the run file to the launch script
# ENTRYPOINT ["bash", "/SwarmUI/launchtools/docker-standard-inner.sh"]

