# Gebruik Ubuntu KDE Webtop voor de beste grafische ondersteuning
FROM lscr.io/linuxserver/webtop:ubuntu-kde

# Voorkom interactieve vragen tijdens installatie
ENV DEBIAN_FRONTEND=noninteractive

# Update en installeer SDRAngel dependencies
RUN apt-get update && apt-get install -y \
    git cmake g++ pkg-config autoconf automake libtool libfftw3-dev libusb-1.0-0-dev libusb-dev libhidapi-dev libopengl-dev \
    qtbase5-dev qtchooser libqt5multimedia5-plugins qtmultimedia5-dev libqt5websockets5-dev \
    qttools5-dev qttools5-dev-tools libqt5opengl5-dev libqt5quick5 libqt5charts5-dev \
    qml-module-qtlocation  qml-module-qtpositioning qml-module-qtquick-window2 \
    qml-module-qtquick-dialogs qml-module-qtquick-controls qml-module-qtquick-controls2 qml-module-qtquick-layouts \
    libqt5serialport5-dev qtdeclarative5-dev qtpositioning5-dev qtlocation5-dev libqt5texttospeech5-dev \
    qtwebengine5-dev qtbase5-private-dev libqt5gamepad5-dev libqt5svg5-dev \
    libfaad-dev libflac-dev zlib1g-dev libboost-all-dev libasound2-dev pulseaudio libopencv-dev libxml2-dev bison flex \
    ffmpeg libavcodec-dev libavformat-dev libopus-dev doxygen graphviz \
    && \
    # Schoon de cache op om de image klein te houden
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*


# build RTL-SDR
RUN mkdir /opt/build; chown $USER:users /opt/build
RUN mkdir /opt/install; chown $USER:users /opt/install
# WORKDIR /opt/build
RUN cd /opt/build
RUN git clone https://github.com/osmocom/rtl-sdr.git librtlsdr
# WORKDIR /opt/build/librtlsdr
RUN cd /opt/build/librtlsdr
RUN git reset --hard 420086af84d7eaaf98ff948cd11fea2cae71734a 
RUN mkdir /opt/build/librtlsdr/build
RUN cd /opt/build/librtlsdr/build
# WORKDIR /opt/build/librtlsdr/build
RUN cmake -Wno-dev -DDETACH_KERNEL_DRIVER=ON -DCMAKE_INSTALL_PREFIX=/opt/install/librtlsdr ..
RUN make -j $(nproc) install

# build SDRANGEL
RUN mkdir /opt/build; chown $USER:users /opt/build
RUN mkdir /opt/install; chown $USER:users /opt/install
# WORKDIR /opt/build
RUN cd /opt/build
RUN git clone https://github.com/f4exb/sdrangel.git sdrangel
# WORKDIR /opt/build/sdrangel
RUN cd /opt/build/sdrangel
RUN mkdir /opt/build/sdrangel/build
RUN cd /opt/build/sdrangel/build
# WORKDIR /opt/build/sdrangel/build
RUN cmake -Wno-dev -DDEBUG_OUTPUT=ON -DRX_SAMPLE_24BIT=ON \
    -DCMAKE_BUILD_TYPE=RelWithDebInfo \
    -DMIRISDR_DIR=/opt/install/libmirisdr \
    -DAIRSPY_DIR=/opt/install/libairspy \
    -DAIRSPYHF_DIR=/opt/install/libairspyhf \
    -DBLADERF_DIR=/opt/install/libbladeRF \
    -DHACKRF_DIR=/opt/install/libhackrf \
    -DRTLSDR_DIR=/opt/install/librtlsdr \
    -DLIMESUITE_DIR=/opt/install/LimeSuite \
    -DIIO_DIR=/opt/install/libiio \
    -DPERSEUS_DIR=/opt/install/libperseus \
    -DXTRX_DIR=/opt/install/xtrx-images \
    -DSOAPYSDR_DIR=/opt/install/SoapySDR \
    -DUHD_DIR=/opt/install/uhd \
    -DAPT_DIR=/opt/install/aptdec \
    -DCM256CC_DIR=/opt/install/cm256cc \
    -DDSDCC_DIR=/opt/install/dsdcc \
    -DSERIALDV_DIR=/opt/install/serialdv \
    -DMBE_DIR=/opt/install/mbelib \
    -DCODEC2_DIR=/opt/install/codec2 \
    -DSGP4_DIR=/opt/install/sgp4 \
    -DLIBSIGMF_DIR=/opt/install/libsigmf \
    -DDAB_DIR=/opt/install/libdab \
    -DGGMORSE_DIR=/opt/install/ggmorse \
    -DINMARSATC_DIR=/opt/install/inmarsatc \
    -DCMAKE_INSTALL_PREFIX=/opt/install/sdrangel ..
RUN make -j $(nproc) install

# Zorg dat de USB-permissies goed staan voor de RTL-SDR
# RUN echo "SUBSYSTEM==\"usb\", ATTRS{idVendor}==\"0bda\", ATTRS{idProduct}==\"2838\", MODE=\"0666\"" > /etc/udev/rules.d/20-rtlsdr.rules

EXPOSE 3000 3001
