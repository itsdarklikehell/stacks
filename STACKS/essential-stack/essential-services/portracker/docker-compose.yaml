services:
  portracker:
    image: ${IMAGE:-mostafawahied/portracker:latest}
    container_name: ${NAME:-portracker}
    restart: ${RESTART:-unless-stopped}

    # Required for comprehensive system port detection
    # This allows Portracker to see all host processes for accurate port mapping
    pid: host

    labels:
      - com.centurylinklabs.watchtower.enable=true
      - com.ouroboros.enable=true
      - autoheal-app
      - autoheal-app=true
      - homarr-app=true
      - homarr

    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Amsterdam}

      # - OAUTHLIB_RELAX_TOKEN_SCOPE=1
      # - DOCKER_MODS=linuxserver/mods:universal-package-install
      # - INSTALL_PACKAGES=libfuse2|git|gdb
      # - RESTART_APP=true

      # CORE CONFIGURATION (Required)
      - DATABASE_PATH=${DATABASE_PATH:-/data/portracker.db}
      # Tell Portracker where to find the host /proc (matches the volume above)
      - POST_PROC=${HOST_PROC:-/host/proc}

      # DOCKER CONFIGURATION
      # Uncomment to use with docker-proxy for enhanced security
      - DOCKER_HOST=${DOCKER_HOST:-tcp://docker-proxy:2375}

      # TRUENAS INTEGRATION (Optional)
      # Uncomment and set your API key for enhanced TrueNAS features:
      # - VM discovery and monitoring
      # - Enhanced system information
      # - TrueNAS-specific optimizations
      # - TRUENAS_API_KEY=your-api-key-here

      # AUTHENTICATION (Optional - v1.2.0+)
      # Enable authentication to protect dashboard access
      # When enabled, users must login to access the dashboard
      # Note: API endpoints for peer communication remain accessible
      # - ENABLE_AUTH=true
      # Optional: Set a custom session secret (recommended for production)
      # If not set, a random secret is generated (sessions won't persist across restarts)
      # - SESSION_SECRET=your-random-secret-here-change-this

      # PERFORMANCE SETTINGS (Optional)
      # Cache duration - increase for better performance, decrease for fresher data
      # - CACHE_TIMEOUT_MS=60000
      # Disable caching entirely (not recommended for production)
      # - DISABLE_CACHE=true

      # ADVANCED PORT SCANNING (Optional)
      # Include UDP ports in scans (may increase noise and impact performance)
      - INCLUDE_UDP=${INCLUDE_UDP:-true}

      # DEVELOPMENT & DEBUGGING (Optional)
      # Enable verbose logging for troubleshooting
      # - DEBUG=${DEBUG:-true}

    volumes:
      # - /etc/localtime:/etc/localtime:ro
      # - /etc/timezone:/etc/timezone:ro

      # Required: Docker socket access for container discovery
      # Comment out if using docker-proxy setup below
      # - /var/run/docker.sock:/var/run/docker.sock

      - portracker_data:/data

    hostname: ${NAME:-portracker}

    # user: ${PUID:-1000}:${PGID:-1000}

    networks:
      host:
      essential-services:

    ports:
      - ${PORT:-4999}:4999

    # Capabilities & security (universal, required)
    # - SYS_PTRACE enables reading other processes' /proc entries on Linux hosts
    # - SYS_ADMIN enables namespace entry on Docker Desktop (macOS/Windows)
    # - apparmor:unconfined disables AppArmor restrictions that may block /proc access
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
      - SYS_NICE
      - NET_ADMIN
      - IPC_LOCK

    security_opt:
      - apparmor:unconfined

    # depends_on:
    #   - docker-proxy

    env_file:
      - ./portracker/.env

    tty: true

    # stdin_open: true

    deploy:
      replicas: 1

    # Optional: Health check for monitoring
    healthcheck:
      test:
        [
          CMD,
          wget,
          --no-verbose,
          --tries=1,
          --spider,
          http://localhost:4999/api/health,
        ]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3

  # OPTIONAL: Enhanced Security with Docker Socket Proxy
  # Uncomment the entire section below for additional Docker socket security
  # This adds a proxy layer between Portracker and the Docker socket
  # When using docker-proxy:
  # 1. Uncomment the entire docker-proxy service above
  # 2. Comment out the /var/run/docker.sock volume mount in portracker service
  # 3. Uncomment the DOCKER_HOST environment variable in portracker service
  # 4. Add depends_on to portracker service:
  #  depends_on:
  #    - docker-proxy

  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: portracker-docker-proxy
    restart: unless-stopped

    labels:
      - com.centurylinklabs.watchtower.enable=true
      - com.ouroboros.enable=true
      - autoheal-app
      - autoheal-app=true
      - homarr-app=true
      - homarr

    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Amsterdam}

      # - OAUTHLIB_RELAX_TOKEN_SCOPE=1
      # - DOCKER_MODS=linuxserver/mods:universal-package-install
      # - INSTALL_PACKAGES=libfuse2|git|gdb
      # - RESTART_APP=true

      # Only allow read operations Portracker needs
      - CONTAINERS=1
      - IMAGES=1
      - INFO=1
      - NETWORKS=1
      # Disable write operations for security
      - POST=0
      - BUILD=0
      - COMMIT=0
      - EXEC=0
      - SWARM=0
      - EVENTS=0
      - VOLUMES=0

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

    hostname: ${NAME:-portracker-docker-proxy}

    # user: ${PUID:-1000}:${PGID:-1000}

    networks:
      host:
      essential-services:

    env_file:
      - ./portracker/.env

    deploy:
      replicas: 1

    tty: true

    # stdin_open: true

    # shm_size: 1gb

    ports:
      - 2375:2375

    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3
# Optional: Custom networks for isolation
# networks:
#   portracker:
#     driver: bridge

# Optional: Named volumes for better data management
# volumes:
#   portracker-data:
#     driver: local
