services:
  netdata:
    image: "${IMAGE:-netdata/netdata}"
    container_name: "${NAME:-netdata}"
    restart: "${RESTART:-unless-stopped}"

    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # - "autoheal-app"
      # - "autoheal-app=true"

    environment:
      - "PUID=${PUID:-1000}"
      - "PGID=${PGID:-1000}"
      - "TZ=${TZ:-Europe/Amsterdam}"
      - "NETDATA_CLAIM_TOKEN=${NETDATA_CLAIM_TOKEN:-3a_tcqnbrp_Dj5VoIvy5pMa3qqdZlxwhV6_x-Armwgw7HVY3DNIDXm9Lm6ZeNbnpmki-IagEPKi-R1_JybqgOQj95QaqNZzh-xc3pc3B0FjfLCmTPZRofZLUnrcUmrEgVhUe26o}"
      - "NETDATA_CLAIM_URL=${NETDATA_CLAIM_URL:-https://app.netdata.cloud}"
      - "NETDATA_CLAIM_ROOMS=${NETDATA_CLAIM_ROOMS:-1a9352b6-d34d-4688-bab5-06a719586033}"
      - "PORT=${PORT:-19996}"

    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "/etc/timezone:/etc/timezone:ro"
      - "netdata_etc:/etc/netdata"
      - "netdata_lib:/var/lib/netdata"
      - "netdata_cache:/var/cache/netdata"
      - "/:/host/root:ro,rslave"
      - "/etc/passwd:/host/etc/passwd:ro"
      - "/etc/group:/host/etc/group:ro"
      - "/proc:/host/proc:ro"
      - "/sys:/host/sys:ro"
      - "/etc/os-release:/host/etc/os-release:ro"
      - "/var/log:/host/var/log:ro"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "/run/dbus:/run/dbus:ro"

    hostname: "${NAME:-netdata}"

    networks:
      host:
      management-services:

    ports:
      - "${PORT:-19996}:19996"

    cap_add:
      - "SYS_PTRACE"
      - "SYS_ADMIN"

    security_opt:
      - "apparmor:unconfined"

    pid: host

    env_file:
      - "./netdata/.env"

    deploy:
      replicas: 1

    tty: true

    stdin_open: true

    # healthcheck:
    #   test:
    #     [
    #       "CMD",
    #       "wget",
    #       "--no-verbose",
    #       "--tries=3",
    #       "--spider",
    #       "http://localhost:${PORT:-19996}/api/health",
    #     ]
    #   interval: "30s"
    #   timeout: "10s"
    #   start_period: "30s"
    #   retries: "3"

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
